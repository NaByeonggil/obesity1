# 관리자 기능 가이드

## 📋 개요

관리자(ADMIN) 역할은 시스템의 모든 사용자와 데이터를 관리할 수 있는 최고 권한을 가집니다.

---

## 🔑 관리자 계정 정보

### 기본 관리자 계정
- **이메일**: admin@obesity.ai.kr
- **비밀번호**: 123456
- **역할**: ADMIN

### 로그인 URL
- **개발 환경**: http://localhost:3000/auth/login?role=admin
- **프로덕션**: https://obesity.ai.kr/auth/login?role=admin

---

## 🚀 주요 기능

### 1. 관리자 대시보드 (`/admin`)

**통계 정보**:
- 전체 사용자 수
- 활성 사용자 수 (최근 30일 내 활동)
- 시스템 알림 수
- 일일 거래 수

**역할별 사용자 분포**:
- 환자(PATIENT)
- 의사(DOCTOR)
- 약사(PHARMACY)
- 관리자(ADMIN)

**가입 통계**:
- 오늘 가입자 수
- 이번 주 가입자 수
- 이번 달 가입자 수

**활동 요약**:
- 총 예약 건수
- 총 처방전 건수
- 오늘 거래 건수

**소셜 로그인 통계**:
- 카카오, 네이버 등 각 플랫폼별 사용자 수

**관리자 도구 바로가기**:
- 사용자 관리
- 데이터 관리
- 시스템 설정
- 통계 분석

---

### 2. 사용자 관리 (`/admin/users`)

#### 사용자 목록 조회
- 페이지네이션 지원 (기본 10명/페이지)
- 역할별 필터링 (전체, 환자, 의사, 약사, 관리자)
- 이름/이메일/전화번호로 검색

**표시 정보**:
- 프로필 사진
- 이름, 이메일
- 역할 배지
- 연락처
- 가입일
- 로그인 방식 (이메일, 카카오, 네이버)

#### 사용자 정보 수정
- 기본 정보: 이름, 전화번호, 역할
- 의사 전용 정보: 전문 분야, 면허 번호
- 약사 전용 정보: 약국명, 약국 주소, 약국 면허 번호

#### 사용자 삭제
- 안전 확인 다이얼로그
- 본인 계정은 삭제 불가
- 관련 데이터 자동 삭제 (CASCADE)

---

## 📊 API 엔드포인트

### 1. 통계 조회
```
GET /api/admin/stats
```

**응답 예시**:
```json
{
  "stats": {
    "totalUsers": 100,
    "activeUsers": 85,
    "systemAlerts": 3,
    "dailyTransactions": 12,
    "usersByRole": {
      "patients": 80,
      "doctors": 15,
      "pharmacies": 4,
      "admins": 1
    },
    "signupStats": {
      "today": 2,
      "thisWeek": 8,
      "thisMonth": 20
    },
    "activityStats": {
      "totalAppointments": 150,
      "totalPrescriptions": 98,
      "dailyTransactions": 12
    },
    "socialLoginStats": {
      "kakao": 45,
      "naver": 23
    },
    "trends": {
      "usersGrowth": 15,
      "appointmentsGrowth": 8,
      "prescriptionsGrowth": 5
    }
  }
}
```

### 2. 사용자 목록 조회
```
GET /api/admin/users?page=1&limit=10&role=PATIENT&search=김
```

**쿼리 파라미터**:
- `page`: 페이지 번호 (기본: 1)
- `limit`: 페이지당 항목 수 (기본: 10)
- `role`: 역할 필터 (ALL, PATIENT, DOCTOR, PHARMACY, ADMIN)
- `search`: 검색어 (이름, 이메일, 전화번호)

**응답 예시**:
```json
{
  "users": [
    {
      "id": "user_123",
      "email": "user@example.com",
      "name": "김철수",
      "phone": "010-1234-5678",
      "role": "PATIENT",
      "avatar": "https://...",
      "createdAt": "2025-10-01T00:00:00.000Z",
      "accounts": [
        {
          "provider": "kakao",
          "provider_account_id": "123456"
        }
      ]
    }
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "limit": 10,
    "totalPages": 10
  }
}
```

### 3. 사용자 정보 수정
```
PUT /api/admin/users
```

**요청 본문**:
```json
{
  "userId": "user_123",
  "data": {
    "name": "김철수",
    "phone": "010-1234-5678",
    "role": "PATIENT",
    "specialization": "내과" // 의사인 경우
  }
}
```

### 4. 사용자 삭제
```
DELETE /api/admin/users?userId=user_123
```

---

## 🔒 권한 관리

### 접근 제어
모든 관리자 API는 다음과 같이 권한을 확인합니다:

```typescript
const session = await getServerSession(authOptions)

if (!session?.user || session.user.role !== 'ADMIN') {
  return NextResponse.json(
    { error: "관리자 권한이 필요합니다." },
    { status: 403 }
  )
}
```

### 보안 규칙
1. 관리자만 접근 가능
2. 본인 계정은 삭제 불가
3. 모든 작업은 감사 로그 기록 (향후 구현)

---

## 🛠️ 관리자 계정 관리

### 새 관리자 계정 생성
```bash
npx ts-node scripts/create-admin.ts
```

이 스크립트는:
- 기본 관리자 계정 생성 (admin@obesity.ai.kr)
- 기존 계정이 있으면 역할을 ADMIN으로 업그레이드
- 생성된 계정 정보 출력

### 기존 사용자를 관리자로 승격
데이터베이스에서 직접 수정:
```sql
UPDATE users SET role = 'ADMIN' WHERE email = 'user@example.com';
```

또는 관리자 페이지에서 사용자 편집 → 역할 변경

---

## 📱 사용 가이드

### 1. 로그인
1. `/auth/login?role=admin` 접속
2. 관리자 이메일/비밀번호 입력
3. 로그인 → `/admin` 대시보드로 이동

### 2. 사용자 관리
1. 대시보드에서 "사용자 관리" 클릭
2. 필터/검색으로 원하는 사용자 찾기
3. 편집 버튼으로 정보 수정
4. 삭제 버튼으로 사용자 삭제 (확인 필요)

### 3. 통계 확인
- 대시보드에서 실시간 통계 확인
- 카드별로 주요 지표 표시
- 트렌드 그래프 (성장률)

---

## 🔄 데이터 흐름

### 사용자 목록 조회 흐름
```
1. 프론트엔드: /admin/users 페이지 접속
2. API 호출: GET /api/admin/users?page=1&limit=10
3. 권한 확인: session.user.role === 'ADMIN'
4. 데이터베이스 쿼리: Prisma로 필터링/페이지네이션
5. 응답: 사용자 목록 + 페이지네이션 정보
6. 프론트엔드: 테이블 렌더링
```

### 사용자 수정 흐름
```
1. 프론트엔드: 편집 버튼 클릭 → 다이얼로그 열기
2. 사용자: 정보 수정 → 저장 버튼 클릭
3. API 호출: PUT /api/admin/users
4. 권한 확인: session.user.role === 'ADMIN'
5. 데이터베이스 업데이트: Prisma update
6. 응답: 성공 메시지
7. 프론트엔드: 목록 새로고침
```

---

## 🎨 UI 구성

### 관리자 대시보드 레이아웃
```
┌─────────────────────────────────────────┐
│ 헤더 (로고, 알림, 프로필)                │
├─────────────────────────────────────────┤
│  사이드바        │   메인 컨텐츠          │
│  - 대시보드      │                       │
│  - 일정 관리     │   통계 카드 (4개)     │
│  - 사용자 관리   │                       │
│  - 시스템 관리   │   관리자 도구 (4개)   │
│  - 통계 분석     │                       │
│  - 설정          │   역할별 분포         │
│                  │   가입 통계            │
│                  │   활동 요약            │
│                  │                       │
│                  │   시스템 알림          │
│                  │   최근 활동            │
└──────────────────┴───────────────────────┘
```

### 사용자 관리 페이지 레이아웃
```
┌─────────────────────────────────────────┐
│ 헤더 (제목, 총 사용자 수)                │
├─────────────────────────────────────────┤
│ 필터/검색 바                             │
│ [검색창] [역할 필터]                     │
├─────────────────────────────────────────┤
│ 사용자 테이블                            │
│ ┌──────┬────────┬──────┬────────┬──────┐│
│ │ 사용자│ 역할  │ 연락처│ 가입일 │ 관리 ││
│ ├──────┼────────┼──────┼────────┼──────┤│
│ │ 김철수│ 환자  │ 010- │ 2025-  │[✏️][🗑]││
│ │      │       │      │        │      ││
│ └──────┴────────┴──────┴────────┴──────┘│
├─────────────────────────────────────────┤
│ 페이지네이션                             │
│ [◀ 이전] [1] [2] [3] ... [다음 ▶]       │
└─────────────────────────────────────────┘
```

---

## 🧪 테스트 시나리오

### 1. 관리자 로그인 테스트
```bash
1. http://localhost:3000/auth/login?role=admin 접속
2. 이메일: admin@obesity.ai.kr
3. 비밀번호: 123456
4. 로그인 → /admin 페이지로 이동 확인
```

### 2. 통계 확인 테스트
```bash
1. 대시보드 접속
2. 전체 사용자 수 확인
3. 역할별 분포 확인
4. 가입 통계 확인
```

### 3. 사용자 관리 테스트
```bash
1. "사용자 관리" 버튼 클릭
2. 사용자 목록 로딩 확인
3. 역할 필터: PATIENT 선택 → 환자만 표시
4. 검색: "김" 입력 → 관련 사용자 표시
5. 사용자 편집:
   - 편집 버튼 클릭
   - 이름 변경
   - 저장 → 목록 새로고침 확인
6. 사용자 삭제:
   - 삭제 버튼 클릭
   - 확인 다이얼로그 표시
   - 삭제 확인 → 목록에서 제거 확인
```

### 4. 페이지네이션 테스트
```bash
1. 사용자 10명 이상 있는지 확인
2. 페이지 번호 클릭 → 다음 페이지 로딩
3. [다음] 버튼 클릭 → 페이지 이동
4. [이전] 버튼 클릭 → 이전 페이지 이동
```

---

## 🐛 문제 해결

### 1. 관리자 로그인 안됨
**원인**: 관리자 계정이 없거나 역할이 ADMIN이 아님

**해결**:
```bash
# 관리자 계정 생성
npx ts-node scripts/create-admin.ts

# 또는 기존 계정 역할 변경
docker exec obesity1_mariadb_production mysql -u obesity1user -pobesity1password obesity1 -e "UPDATE users SET role = 'ADMIN' WHERE email = 'admin@obesity.ai.kr';"
```

### 2. 통계 데이터가 안 나옴
**원인**: API 오류 또는 데이터베이스 연결 실패

**해결**:
```bash
# 개발 서버 로그 확인
npm run dev

# 데이터베이스 연결 확인
npx prisma studio
```

### 3. 사용자 삭제 안됨
**원인**: 본인 계정 삭제 시도 또는 관련 데이터 있음

**해결**:
- 본인이 아닌 다른 사용자 삭제 시도
- 관련 데이터(예약, 처방전) 먼저 삭제

---

## 📝 향후 개선 사항

### 1. 기능 추가
- [ ] 감사 로그 (모든 관리 작업 기록)
- [ ] 대량 작업 (여러 사용자 동시 수정/삭제)
- [ ] 사용자 내보내기 (CSV, Excel)
- [ ] 고급 필터링 (가입일, 활동일 등)
- [ ] 사용자 활동 상세 조회
- [ ] 시스템 알림 관리
- [ ] 데이터 백업/복원

### 2. UI 개선
- [ ] 대시보드 차트 추가 (성장 추이 그래프)
- [ ] 실시간 통계 업데이트
- [ ] 다크 모드 지원
- [ ] 모바일 반응형 개선

### 3. 보안 강화
- [ ] 2단계 인증 (2FA)
- [ ] IP 화이트리스트
- [ ] 세션 타임아웃 설정
- [ ] 비밀번호 정책 강화

---

**작성일**: 2025-11-01
**버전**: 1.0.0
**작성자**: Claude Code Assistant
